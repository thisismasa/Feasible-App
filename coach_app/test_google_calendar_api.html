<!DOCTYPE html>
<html>
<head>
    <title>Google Calendar API Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #1a73e8; }
        button {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover { background: #1557b0; }
        .log {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #0f9d58; }
        .error { color: #d93025; }
        .info { color: #1a73e8; }
        .warning { color: #f9ab00; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Google Calendar API Test</h1>
        <p>This page tests your Google Calendar API configuration</p>

        <button onclick="testAPIKey()">1. Test API Key</button>
        <button onclick="signIn()">2. Sign In with Google</button>
        <button onclick="testCreateEvent()">3. Test Create Event</button>
        <button onclick="clearLog()">Clear Log</button>

        <div class="log" id="log"></div>
    </div>

    <script>
        const CLIENT_ID = '576001465184-pv04h51b3pl92hkdibgssabm2cegbq6r.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyDCjQsRx8tMpvu9bQVgMr3ezc_K1Ru6jFk';
        const SCOPES = 'https://www.googleapis.com/auth/calendar';

        let tokenClient;
        let accessToken = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type;
            logDiv.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Load Google API
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
            log('‚úÖ GAPI loaded', 'success');
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'],
                });
                log('‚úÖ Google Calendar API initialized', 'success');
            } catch (error) {
                log('‚ùå Failed to initialize API: ' + error.message, 'error');
            }
        }

        // Load Google Identity Services
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.error !== undefined) {
                        log('‚ùå OAuth error: ' + response.error, 'error');
                        throw (response);
                    }
                    accessToken = response.access_token;
                    gapi.client.setToken({access_token: accessToken});
                    log('‚úÖ Access token received!', 'success');
                    log('üìù Token: ' + accessToken.substring(0, 20) + '...', 'info');
                },
            });
            log('‚úÖ Google Identity Services loaded', 'success');
        }

        // Test 1: Test API Key
        async function testAPIKey() {
            log('üîç Testing API Key...', 'info');

            try {
                const response = await fetch(
                    `https://www.googleapis.com/calendar/v3/users/me/calendarList?key=${API_KEY}`,
                    { method: 'GET' }
                );

                if (response.ok) {
                    log('‚úÖ API Key is valid!', 'success');
                } else {
                    const error = await response.json();
                    log('‚ùå API Key test failed: ' + error.error.message, 'error');
                    log('üí° Check: Is Calendar API enabled in Google Cloud Console?', 'warning');
                }
            } catch (error) {
                log('‚ùå Network error: ' + error.message, 'error');
            }
        }

        // Test 2: Sign In
        function signIn() {
            log('üîê Requesting OAuth token...', 'info');

            if (tokenClient) {
                tokenClient.callback = async (response) => {
                    if (response.error !== undefined) {
                        log('‚ùå Sign-in failed: ' + response.error, 'error');
                        return;
                    }

                    accessToken = response.access_token;
                    gapi.client.setToken({access_token: accessToken});

                    log('‚úÖ Successfully signed in!', 'success');
                    log('üìù Access Token: ' + accessToken.substring(0, 30) + '...', 'success');

                    // Get user info
                    try {
                        const calendarList = await gapi.client.calendar.calendarList.list();
                        log('‚úÖ Can access calendars!', 'success');
                        log('üìÖ Found ' + calendarList.result.items.length + ' calendars', 'info');
                    } catch (error) {
                        log('‚ùå Cannot access calendars: ' + error.message, 'error');
                    }
                };

                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                log('‚ùå Token client not initialized. Refresh the page.', 'error');
            }
        }

        // Test 3: Create Calendar Event
        async function testCreateEvent() {
            if (!accessToken) {
                log('‚ö†Ô∏è Please sign in first (click "Sign In with Google")', 'warning');
                return;
            }

            log('üìÖ Creating test calendar event...', 'info');

            const event = {
                summary: 'TEST: PT Session - API Test',
                description: 'This is a test event created by the Google Calendar API test page',
                start: {
                    dateTime: new Date(Date.now() + 3600000).toISOString(), // 1 hour from now
                    timeZone: 'Asia/Bangkok',
                },
                end: {
                    dateTime: new Date(Date.now() + 7200000).toISOString(), // 2 hours from now
                    timeZone: 'Asia/Bangkok',
                },
                reminders: {
                    useDefault: false,
                    overrides: [
                        {method: 'popup', minutes: 30},
                    ],
                },
            };

            try {
                const request = await gapi.client.calendar.events.insert({
                    calendarId: 'primary',
                    resource: event,
                });

                const response = request.result;
                log('‚úÖ Calendar event created successfully!', 'success');
                log('üìù Event ID: ' + response.id, 'success');
                log('üîó Event Link: ' + response.htmlLink, 'success');
                log('‚è∞ Start Time: ' + new Date(response.start.dateTime).toLocaleString(), 'info');
                log('', 'info');
                log('üéâ SUCCESS! Your Google Calendar API is working!', 'success');
                log('üí° You can now use calendar sync in your app', 'success');
                log('', 'info');
                log('üóëÔ∏è You can delete this test event from Google Calendar', 'info');
            } catch (error) {
                log('‚ùå Failed to create event: ' + error.message, 'error');
                log('üí° Check console for more details', 'warning');
                console.error('Full error:', error);
            }
        }
    </script>

    <!-- Google API -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
